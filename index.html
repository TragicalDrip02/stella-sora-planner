<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stella Sora â€” Ascension Planner</title>

  <!-- Inter font for readability -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-dark: #0f1724;
      --panel-dark: #0b1220;
      --card-dark: #0d1420;
      --muted-dark: #9aa6b2;
      --text-dark: #ecf6ff;
      --accent: #60b8ff;
      --glass: rgba(255, 255, 255, 0.02);

      --bg-light: #f5f8fb;
      --panel-light: #ffffff;
      --card-light: #f7f9fc;
      --muted-light: #6b7480;
      --text-light: #0b1720;
      --accent-light: #2a6bff;
    }

    /* Default = dark mode */
    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      padding: 26px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: var(--bg-dark);
      color: var(--text-dark);
      -webkit-font-smoothing: antialiased;
      transition: background .25s ease, color .25s ease;
    }

    body.light {
      background: var(--bg-light);
      color: var(--text-light);
    }

    .panel {
      background: var(--panel-dark);
      color: var(--text-dark);
    }

    body.light .panel {
      background: var(--panel-light);
      color: var(--text-light);
    }

    .card {
      background: var(--card-dark);
      color: var(--text-dark);
    }

    body.light .card {
      background: var(--card-light);
      color: var(--text-light);
    }

    .muted {
      color: var(--muted-dark);
    }

    body.light .muted {
      color: var(--muted-light);
    }

    * {
      box-sizing: border-box
    }

    .app {
      max-width: 1180px;
      margin: 0 auto;
    }

    .top-nav {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 14px;
    }

    .nav-button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      color: inherit;
      cursor: pointer;
      font-weight: 700;
    }

    .spacer {
      margin-left: auto;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .materials-summary {
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      margin-bottom: 18px;
    }

    body.light .materials-summary {
      border-color: rgba(10, 20, 30, 0.06);
    }

    .materials-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .materials-title {
      font-size: 1.1rem;
      font-weight: 800;
      margin: 0;
    }

    .materials-mode-buttons {
      display: flex;
      gap: 8px;
    }

    .materials-mode-btn {
      font-size: 0.85rem;
      padding: 6px 10px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.03);
      cursor: pointer;
      color: inherit;
    }

    .materials-mode-btn:hover {
      filter: brightness(1.15);
    }

    .materials-mode-btn.active {
      background: var(--accent);
      color: #072233;
      font-weight: 700;
    }

    .materials-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(72px, 1fr));
      gap: 12px;
      align-items: center;
    }

    .material {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 8px;
      border-radius: 10px;
      background: var(--glass);
      border: 1px solid rgba(255, 255, 255, 0.03);
      min-height: 84px;
      justify-content: center;
    }

    .material img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.06);
    }

    .mat-count {
      font-weight: 800;
      margin-top: 4px;
      font-size: 1rem;
      color: inherit;
    }

    .character-grid-wrap {
      display: flex;
      gap: 18px;
      align-items: flex-start;
      justify-content: center;
    }

    .character-grid {
      flex: 1 1 880px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 18px;
      padding-left: 8px;
    }

    @media(max-width:1100px) {
      .character-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media(max-width:900px) {
      .character-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media(max-width:640px) {
      .character-grid {
        grid-template-columns: repeat(1, 1fr);
      }
    }

    .character-card {
      width: 100%;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.03);
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 180px;
      transition: opacity .18s, filter .18s, box-shadow .18s;
    }

    .character-card.dimmed {
      opacity: 0.36;
      filter: grayscale(.6);
    }

    body.light .character-card {
      border-color: rgba(0, 0, 0, 0.06);
    }

    .char-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .char-actions-left,
    .char-actions-right {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .char-name {
      font-weight: 800;
      text-align: center;
      flex: 1;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .icon-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      transition: background .12s;
      color: inherit;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .icon-btn svg {
      width: 16px;
      height: 16px;
      display: block;
    }

    .char-body {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .char-portrait {
      width: 86px;
      height: 86px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
    }

    .char-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .char-levels,
    .char-skills {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.02);
      background: transparent;
    }

    .char-skills .skill-row {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      font-size: 13px;
    }

    .char-skills .skill-label {
      font-weight: 700;
      color: inherit;
    }

    .char-materials {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .char-material {
      width: 56px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.02);
      background: transparent;
    }

    .char-material img {
      width: 36px;
      height: 36px;
      object-fit: contain;
      border-radius: 6px;
    }

    .level-select {
      width: 64px;
      padding: 6px;
      border-radius: 6px;
      font-size: 0.95rem;
      text-align: center;
    }

    .modal {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.open {
      display: flex;
    }

    .inventory-modal-panel {
      width: 96%;
      max-height: 86vh;
      border-radius: 12px;
      padding: 18px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: auto;
      background: var(--panel-dark);
    }

    .modal-panel-list {
      width: 96%;
      max-height: 86vh;
      border-radius: 12px;
      padding: 18px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: auto;
      background: var(--panel-dark);
    }

    .modal-panel-details {
      width: 96%;
      max-width: 700px;
      max-height: 86vh;
      border-radius: 12px;
      padding: 18px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: auto;
      background: var(--panel-dark);
    }

    body.light .modal-panel-list,
    body.light .modal-panel-details,
    body.light .inventory-modal-panel {
      background: var(--panel-light);
      border-color: rgba(0, 0, 0, 0.06);
    }

    .modal-controls select,
    .modal-controls input {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(0, 0, 0, 0.08);
      color: inherit;
    }

    .modal-tiles {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      padding: 6px;
      flex: 1;
    }

    .tile {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.03);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }

    .tile img {
      width: 72px;
      height: 72px;
      object-fit: contain;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.06);
    }

    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 6px 8px;
      border-radius: 6px;
      white-space: nowrap;
      font-size: 12px;
      z-index: 2000;
    }

    .inv-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .inv-filter-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .inv-dorra-center {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      flex: 1;
    }

    .inv-dorra-center img {
      width: 36px;
      height: 36px;
    }

    .inv-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 8px;
      overflow: auto;
      padding: 6px;
      flex: 1 1 auto;
    }

    .inv-item {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      border-radius: 10px;
      padding: 10px 8px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.03);
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      min-height: 88px;
      justify-content: center;
    }

    .inv-item img {
      width: 52px;
      height: 52px;
      object-fit: contain;
      border-radius: 8px;
    }

    .inv-input {
      width: 64px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(0, 0, 0, 0.08);
      text-align: center;
      color: inherit;
    }

    @media(max-width:1200px) {
      .inv-grid {
        grid-template-columns: repeat(8, 1fr);
      }
    }

    @media(max-width:800px) {
      .inv-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media(max-width:420px) {
      .inv-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .small {
      font-size: 12px;
      color: var(--muted-dark);
    }

    body.light .small {
      color: var(--muted-light);
    }

    /* disabled tile appearance for already-added characters in modal */
    .tile.disabled {
      opacity: 0.36;
      filter: grayscale(.6);
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top-nav">
      <button id="addCharacterBtn" class="nav-button">Add Character</button>
      <button id="addDiscBtn" class="nav-button">Add Disc</button>
      <button id="manageInventoryBtn" class="nav-button">Manage Inventory</button>
      <button id="managePriorityBtn" class="nav-button">Manage Priority</button>

      <div class="spacer">
        <button id="themeToggle" class="nav-button">ðŸŒ™</button>
        <button id="importBtn" class="nav-button">Import JSON</button>
        <button id="exportBtn" class="nav-button">Export JSON</button>
      </div>
    </div>

    <div class="materials-summary panel">
      <div class="materials-header">
        <div style="display:flex;align-items:center;gap:12px">
          <h2 class="materials-title">Total Materials Needed</h2>
        </div>
        <div class="materials-mode-buttons">
          <button id="btnTotalNeeded" class="materials-mode-btn">Total Needed</button>
          <button id="btnRemainingNeeded" class="materials-mode-btn">Remaining Needed</button>
        </div>
      </div>

      <div id="materialsGrid" class="materials-grid"></div>
    </div>

    <div class="character-grid-wrap">
      <div id="characterGrid" class="character-grid"></div>
    </div>
  </div>

  <!-- List Modal (Select Character) -->
  <div id="listModal" class="modal" aria-hidden="true">
    <div class="modal-panel-list panel" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong style="font-size:1.1rem">Select Character</strong>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="listSearch" placeholder="Search..."
            style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.08);color:inherit">
          <button id="closeListModal" class="nav-button">Close</button>
        </div>
      </div>

      <!-- Sorting select added here -->
      <div style="display:flex;gap:10px;align-items:center;">
        <label class="small muted" style="margin:0">Sort:
          <select id="sortCharactersSelect"
            style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.06);color:inherit">
            <option value="default">Default</option>
            <option value="name">Name</option>
            <option value="element">Element</option>
            <option value="quality">Rarity</option>
            <option value="position">Position</option>
            <option value="faction">Faction</option>
          </select>
        </label>

        <!-- Existing filters container -->
        <div id="listFilters" class="modal-controls" style="margin-left:auto"></div>
      </div>

      <div id="modalTiles" class="modal-tiles" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- Details Modal -->
  <div id="detailsModal" class="modal" aria-hidden="true">
    <div class="modal-panel-details panel" role="dialog" aria-modal="true">
      <div style="display:flex;align-items:center;gap:12px">
        <div id="detailsPortrait"
          style="width:64px;height:64px;border-radius:10px;background-size:contain;background-repeat:no-repeat;background-position:center;border:1px solid rgba(255,255,255,0.04)">
        </div>
        <div>
          <div id="detailsName" style="font-weight:800">Character</div>
          <div id="detailsSub" class="small muted"></div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr;gap:12px;align-items:start;">
        <div>
          <label class="small">Levels</label>
          <div style="display:flex;gap:12px;align-items:center;">
            <div style="display:flex;flex-direction:column;align-items:center;">
              <div class="hdr" style="margin-bottom:4px;">Current</div>
              <select id="curLevel" class="level-select"></select>
            </div>
            <div style="display:flex;flex-direction:column;align-items:center;">
              <div class="hdr" style="margin-bottom:4px;">Desired</div>
              <select id="desLevel" class="level-select"></select>
            </div>
          </div>
          <div style="margin-top:10px">
            <label class="small">Talents</label>
            <input id="talentsInput" type="number" min="0" max="10" value="0"
              style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.08);color:inherit" />
          </div>
        </div>

        <div>
          <div style="font-weight:700; margin-bottom:6px">Skills</div>
          <div class="skills-column" style="margin-top:8px">
            <div class="skill-set">
              <div class="small skill-label" style="margin-bottom:6px">Attack</div>
              <div style="display:flex;gap:8px;align-items:center"><select class="skill-cur"></select>
                <div>â†’</div><select class="skill-des"></select>
              </div>
            </div>
            <div class="skill-set">
              <div class="small skill-label" style="margin-bottom:6px">Main</div>
              <div style="display:flex;gap:8px;align-items:center"><select class="skill-cur"></select>
                <div>â†’</div><select class="skill-des"></select>
              </div>
            </div>
            <div class="skill-set">
              <div class="small skill-label" style="margin-bottom:6px">Support</div>
              <div style="display:flex;gap:8px;align-items:center"><select class="skill-cur"></select>
                <div>â†’</div><select class="skill-des"></select>
              </div>
            </div>
            <div class="skill-set">
              <div class="small skill-label" style="margin-bottom:6px">Ultimate</div>
              <div style="display:flex;gap:8px;align-items:center"><select class="skill-cur"></select>
                <div>â†’</div><select class="skill-des"></select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="obtainedFlag"><label for="obtainedFlag" class="small muted" style="margin:0">Obtained
          in-game</label>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="saveDetails" class="nav-button"
          style="background:linear-gradient(180deg,#4fd6ff,#6aa7ff);font-weight:800">Save</button>
        <button id="detailsClose" class="nav-button">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Inventory Modal -->
  <div id="inventoryModal" class="modal" aria-hidden="true">
    <div class="inventory-modal-panel panel" role="dialog" aria-modal="true">
      <div class="inv-topbar">
        <div class="inv-filter-left">
          <label class="small muted" style="margin:0">Filter:
            <select id="inventoryFilter"
              style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.08);color:inherit">
              <option>All</option>
              <option>Experience</option>
              <option>Character</option>
              <option>Disc</option>
              <option>Skill Materials</option>
              <option>Disc Materials</option>
              <option>Ascension Materials</option>
              <option>Weekly Boss</option>
              <option>Emblems</option>
              <option>Gifts</option>
              <option>Miscellaneous</option>
            </select>
          </label>
        </div>

        <div class="inv-dorra-center">
          <img src="" id="dorraImage" alt="Dorra">
          <input id="inventoryDorra" type="number" min="0" placeholder="0"
            style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.08);color:inherit;width:160px;text-align:center">
        </div>

        <div class="inv-controls-right">
          <input id="invImportFile" type="file" accept="application/json" style="display:none" />
          <button id="inventoryImport" class="nav-button">Import JSON</button>
          <button id="inventoryExport" class="nav-button">Export JSON</button>
          <button id="inventorySaveClose" class="nav-button">Save and Close</button>
        </div>
      </div>

      <div id="inventoryGrid" class="inv-grid"></div>

      <div style="display:flex;justify-content:flex-end;margin-top:8px">
        <button id="inventoryDeleteAll" class="nav-button"
          style="background:linear-gradient(180deg,#ff6b6b,#ff8f8f);">Delete All Inventory</button>
      </div>
    </div>
  </div>


  <script>
    /* ---------------------------
       Small helpers
    ----------------------------*/
    const $ = (s, ctx = document) => ctx.querySelector(s);
    const $$ = (s, ctx = document) => Array.from((ctx || document).querySelectorAll(s));
    const el = (t, a = {}, txt = '') => {
      const n = document.createElement(t);
      for (const k in a) {
        if (k.startsWith('on') && typeof a[k] === 'function')
          n.addEventListener(k.slice(2), a[k]);
        else
          n.setAttribute(k, a[k]);
      }
      if (txt) n.textContent = txt;
      return n;
    };

    /* ---------------------------
       Per-material explicit image paths
    ----------------------------*/
    const MATERIAL_IMAGE_PATHS = {
      // Experience materials
      "trekkers_guide": "materials/trekkers_guide.png",
      "novices_internship_journal": "materials/novices_internship_journal.png",
      "senior_travel_journal": "materials/senior_travel_journal.png",
      "trekkers_handwritten_encyclopedia": "materials/trekkers_handwritten_encyclopedia.png",

      // Ascension (Trekker Ascension groups)
      "backstage_ragged_hat": "materials/backstage_ragged_hat.png",
      "spotlight_bowler": "materials/spotlight_bowler.png",
      "exeunt_bowler": "materials/exeunt_bowler.png",
      "faint_wick": "materials/faint_wick.png",
      "lumen_essence": "materials/lumen_essence.png",
      "eternal_gloom_core": "materials/eternal_gloom_core.png",
      "counts_rewards": "materials/count_s_rewards.png",
      "counts_cellaring": "materials/count_s_cellaring.png",
      "counts_gift": "materials/count_s_gift.png",

      // Disc Ascension
      "eerier_breath": "materials/eerier_breath.png",
      "phantom_step_remnant": "materials/phantom_step_remnant.png",
      "frenzied_waltz_essence": "materials/frenzied_waltz_essence.png",
      "faint_light_breath": "materials/faint_light_breath.png",
      "emberflies_soul": "materials/emberflies_soul.png",
      "evernight_essence": "materials/evernight_essence.png",
      "duloos_breath": "materials/duloos_breath.png",
      "duloos_soul_remnant": "materials/duloos_soul_remnant.png",
      "duloos_essence": "materials/duloos_essence.png",

      // Weekly boss materials (skill bosses)
      "crimson_tempter": "materials/crimson_tempter.png",
      "evil_bloom_essence": "materials/evil_bloom_essence.png",
      "forest_elf_fang": "materials/forest_elf_fang.png",
      "forest_elf_essence": "materials/forest_elf_essence.png",
      "colossus_core": "materials/colossus_core.png",
      "colossus_essence": "materials/colossus_essence.png",
      "wrath_beauty": "materials/wrath_beauty.png",
      "wind_essence": "materials/wind_essence.png",
      "radiant_feather_crown": "materials/radiant_feather_crown.png",
      "radiant_crown_essence": "materials/radiant_crown_essence.png",
      "nightlit_haven": "materials/nightlit_haven.png",
      "tidal_essence": "materials/tidal_essence.png",

      // Skill cartridges
      "tapping_game_cartridge": "materials/tapping_game_cartridge.png",
      "rhythm_game_cartridge": "materials/rhythm_game_cartridge.png",
      "magic_sound_game_cartridge": "materials/magic_sound_game_cartridge.png",
      "shooter_game_cartridge": "materials/shooter_game_cartridge.png",
      "barrage_game_cartridge": "materials/barrage_game_cartridge.png",
      "demon_bee_game_cartridge": "materials/demon_bee_game_cartridge.png",
      "kung_fu_game_cartridge": "materials/kung_fu_game_cartridge.png",
      "fighting_game_cartridge": "materials/fighting_game_cartridge.png",
      "phantom_game_cartridge": "materials/phantom_game_cartridge.png",
      "chess_piece_of_skill": "materials/chess_piece_of_skill.png",

      // Discs & misc
      "cracked_disc": "disc/cracked_disc.png",
      "pure_quality_treasure": "disc/pure_quality_treasure.png",
      "elegant_rim": "disc/elegant_rim.png",
      "starlit_colored_glass": "disc/starlit_colored_glass.png",

      // Emblems
      "good_citizen_point": "materials/good_citizen_point.png",
      "association_contribution_certificate": "materials/association_contribution_certificate.png",
      "grace_voucher": "materials/grace_voucher.png",

      // Gifts 
      "love_candle": "gifts/love_candle.png",
      "blazing_wings": "gifts/blazing_wings.png",
      "card_photo_capturer": "gifts/card_photo_capturer.png",
      "reflective_photo_capturer": "gifts/reflective_photo_capturer.png",
      "portable_blower": "gifts/portable_blower.png",
      "exquisite_blower": "gifts/exquisite_blower.png",
      "whisper_wind_spinner": "gifts/whisper_wind_spinner.png",
      "chilling_wind_spinner": "gifts/chilling_wind_spinner.png",
      "rising_star": "gifts/rising_star.png",
      "emerging_talent": "gifts/emerging_talent.png",
      "stellanite_enchantment": "gifts/stellanite_enchantment.png",
      "moonlit_companion": "gifts/moonlit_companion.png",
      "summer_chill_crushed_ice": "gifts/summer_chill_crushed_ice.png",
      "fragrant_ice_delight": "gifts/fragrant_ice_delight.png",
      "gilded_ceramic_bowl": "gifts/gilded_ceramic_bowl.png",
      "blossom_porcelain_cup": "gifts/blossom_porcelain_cup.png",

      // Dorra, Experience fallback images
      "dorra": "currencies/dorra.png",
      "experience": "materials/experience.png"
    };

    /* ---------------------------
       Material category map
    ----------------------------*/
    const MATERIAL_CATEGORY_MAP = {
      "Trekker's Guide": "Experience", "Novice's Internship Journal": "Experience", "Senior's Travel Journal": "Experience", "Trekker's Handwritten Encyclopedia": "Experience",
      "Cracked Disc": "Disc", "Pure Quality Treasure": "Disc", "Elegant Rim": "Disc", "Starlit Colored Glass": "Disc",
      "Tapping Game Cartridge": "Skill Materials", "Rhythm Game Cartridge": "Skill Materials", "Magic Sound Game Cartridge": "Skill Materials", "Shooter Game Cartridge": "Skill Materials", "Barrage Game Cartridge": "Skill Materials", "Demon Bee Game Cartridge": "Skill Materials", "Kung Fu Game Cartridge": "Skill Materials", "Fighting Game Cartridge": "Skill Materials", "Phantom Game Cartridge": "Skill Materials", "Chess Piece of Skill": "Skill Materials",
      "Backstage Ragged Hat": "Ascension Materials", "Spotlight Bowler": "Ascension Materials", "Exeunt Bowler": "Ascension Materials", "Faint Wick": "Ascension Materials", "Lumen Essence": "Ascension Materials", "Eternal Gloom Core": "Ascension Materials", "Count's Rewards": "Ascension Materials", "Count's Cellaring": "Ascension Materials", "Count's Gift": "Ascension Materials", "Eerier Breath": "Ascension Materials", "Faint Light Breath": "Ascension Materials", "Duloos Breath": "Ascension Materials",
      "Crimson Tempter": "Weekly Boss", "Evil Bloom Essence": "Weekly Boss", "Forest Elf Fang": "Weekly Boss", "Forest Elf Essence": "Weekly Boss", "Colossus Core": "Weekly Boss", "Colossus Essence": "Weekly Boss", "Wrath Beauty": "Weekly Boss", "Wind Essence": "Weekly Boss", "Radiant Feather Crown": "Weekly Boss", "Radiant Crown Essence": "Weekly Boss", "Nightlit Haven": "Weekly Boss", "Tidal Essence": "Weekly Boss",
      "Good Citizen Point": "Emblems", "Association Contribution Certificate": "Emblems", "Grace Voucher": "Emblems",
      "Love Candle": "Gifts", "Blazing Wings": "Gifts", "Card Photo Capturer": "Gifts", "Reflective Photo Capturer": "Gifts", "Portable Blower": "Gifts", "Exquisite Blower": "Gifts", "Whisper Wind Spinner": "Gifts", "Chilling Wind Spinner": "Gifts", "Rising Star": "Gifts", "Emerging Talent": "Gifts", "Stellanite Enchantment": "Gifts", "Moonlit Companion": "Gifts", "Summer Chill Crushed Ice": "Gifts", "Fragrant Ice Delight": "Gifts", "Gilded Ceramic Bowl": "Gifts", "Blossom Porcelain Cup": "Gifts",
      "Dorra": "Currency"
    };

    /* ---------------------------
       Asset Base URL Configuration
    ----------------------------*/
    function getAssetBase() {
      if (window.location.hostname.includes('github.io')) {
        const pathParts = window.location.pathname.split('/');
        const username = pathParts[1];
        const repo = pathParts[2];
        if (repo) {
          return `/${username}/${repo}/`;
        }
        return `/${username}/`;
      }
      return './';
    }

    const ASSET_BASE = getAssetBase();

    function safeKey(str) {
      return (str || '').toLowerCase().replace(/\s+/g, '_').replace(/[^\w]/g, '');
    }

    function getMaterialImagePath(materialName) {
      if (!materialName) return 'assets/materials/default.png';
      const key = safeKey(materialName);

      if (MATERIAL_IMAGE_PATHS[key]) return MATERIAL_IMAGE_PATHS[key];

      const map = MATERIAL_CATEGORY_MAP[materialName] || '';
      let folder = 'materials';

      if (map === 'Gifts') folder = 'gifts';
      else if (map === 'Disc') folder = 'disc';
      else if (map === 'Currency') folder = 'currencies';

      return `assets/${folder}/${key}.png`;
    }

    function ensureImage(p) {
      if (!p) return ASSET_BASE + 'assets/materials/default.png';
      if (p.startsWith('http') || p.startsWith('data:')) return p;

      if (p.includes('/')) {
        return ASSET_BASE + p;
      }

      if (p.includes('characters/')) {
        return ASSET_BASE + p;
      }

      return ASSET_BASE + getMaterialImagePath(p);
    }

    /* ---------------------------
       Character & material data
    ----------------------------*/
    const manifestCharacters = [
      { id: "amber", name: "Amber", position: "Vanguard", element: "Ignis", quality: "4", faction: "New Star Guild", style: "Collector", image: "assets/characters/amber.png" },
      { id: "ann", name: "Ann", position: "Support", element: "Ventus", quality: "4", faction: "Freelance Trekker", style: "Adventurous", image: "assets/characters/ann.png" },
      { id: "canace", name: "Canace", position: "Versatile", element: "Ventus", quality: "4", faction: "Freelance Trekker", style: "Adventurous", image: "assets/characters/canace.png" },
      { id: "caramel", name: "Caramel", position: "Vanguard", element: "Umbra", quality: "4", faction: "Freelance Trekker", style: "Creative", image: "assets/characters/caramel.png" },
      { id: "chitose", name: "Chitose", position: "Vanguard", element: "Aqua", quality: "5", faction: "Freelance Trekker", style: "Inquisitive", image: "assets/characters/chitose.png" },
      { id: "chixia", name: "Chixia", position: "Versatile", element: "Ignis", quality: "5", faction: "Yunji Studio", style: "Collector", image: "assets/characters/chixia.png" },
      { id: "coronis", name: "Coronis", position: "Support", element: "Umbra", quality: "4", faction: "Freelance Trekker", style: "Adventurous", image: "assets/characters/coronis.png" },
      { id: "cosette", name: "Cosette", position: "Support", element: "Umbra", quality: "4", faction: "Freelance Trekker", style: "Inquisitive", image: "assets/characters/cosette.png" },
      { id: "flora", name: "Flora", position: "Support", element: "Ignis", quality: "4", faction: "Freelance Trekker", style: "Collector", image: "assets/characters/flora.png" },
      { id: "freesia", name: "Freesia", position: "Versatile", element: "Aqua", quality: "5", faction: "Post Haste", style: "Adventurous", image: "assets/characters/freesia.png" },
      { id: "gerie", name: "Gerie", position: "Vanguard", element: "Terra", quality: "5", faction: "Grace Imperium", style: "Inquisitive", image: "assets/characters/gerie.png" },
      { id: "iris", name: "Iris", position: "Versatile", element: "Aqua", quality: "4", faction: "New Star Guild", style: "Creative", image: "assets/characters/iris.png" },
      { id: "jinglin", name: "Jinglin", position: "Versatile", element: "Lux", quality: "4", faction: "Fenhuang Diner", style: "Inquisitive", image: "assets/characters/jinglin.png" },
      { id: "kasimira", name: "Kasimira", position: "Versatile", element: "Ignis", quality: "4", faction: "White Cat Troupe", style: "Adventurous", image: "assets/characters/kasimira.png" },
      { id: "laru", name: "Laru", position: "Vanguard", element: "Lux", quality: "4", faction: "Grace Imperium", style: "Adventurous", image: "assets/characters/laru.png" },
      { id: "minova", name: "Minova", position: "Versatile", element: "Lux", quality: "5", faction: "Ashwind Clan", style: "Steady", image: "assets/characters/minova.png" },
      { id: "mistique", name: "Mistique", position: "Versatile", element: "Umbra", quality: "5", faction: "Scarlet Sights Media", style: "Creative", image: "assets/characters/mistique.png" },
      { id: "nanoha", name: "Nanoha", position: "Vanguard", element: "Ventus", quality: "5", faction: "Goodwind Homecare", style: "Inquisitive", image: "assets/characters/nanoha.png" },
      { id: "nazuna", name: "Nazuna", position: "Support", element: "Terra", quality: "5", faction: "Petal Bloom Guild", style: "Collector", image: "assets/characters/nazuna.png" },
      { id: "noya", name: "Noya", position: "Vanguard", element: "Ventus", quality: "4", faction: "New Star Guild", style: "Creative", image: "assets/characters/noya.png" },
      { id: "ridge", name: "Ridge", position: "Versatile", element: "Terra", quality: "4", faction: "United Harvest", style: "Collector", image: "assets/characters/ridge.png" },
      { id: "shia", name: "Shia", position: "Vanguard", element: "Lux", quality: "5", faction: "Freelance Trekker", style: "Adventurous", image: "assets/characters/shia.png" },
      { id: "shimiao", name: "Shimiao", position: "Vanguard", element: "Aqua", quality: "4", faction: "Baize Bureau", style: "Inquisitive", image: "assets/characters/shimiao.png" },
      { id: "teresa", name: "Teresa", position: "Support", element: "Aqua", quality: "4", faction: "Post Haste", style: "Steady", image: "assets/characters/teresa.png" },
      { id: "tilia", name: "Tilia", position: "Support", element: "Lux", quality: "4", faction: "Imperial Guard", style: "Steady", image: "assets/characters/tilia.png" }
    ];

    const characterAscensionMaterials = {
      amber: ["Count's Rewards", "Count's Cellaring", "Count's Gift"],
      ann: ["Backstage Ragged Hat", "Spotlight Bowler", "Exeunt Bowler"],
      canace: ["Count's Rewards", "Count's Cellaring", "Count's Gift"],
      caramel: ["Faint Wick", "Lumen Essence", "Eternal Gloom Core"],
      chitose: ["Backstage Ragged Hat", "Spotlight Bowler", "Exeunt Bowler"],
      chixia: ["Backstage Ragged Hat", "Spotlight Bowler", "Exeunt Bowler"],
      coronis: ["Count's Rewards", "Count's Cellaring", "Count's Gift"],
      cosette: ["Backstage Ragged Hat", "Spotlight Bowler", "Exeunt Bowler"],
      flora: ["Faint Wick", "Lumen Essence", "Eternal Gloom Core"],
      freesia: ["Faint Wick", "Lumen Essence", "Eternal Gloom Core"],
      gerie: ["Backstage Ragged Hat", "Spotlight Bowler", "Exeunt Bowler"],
      iris: ["Faint Wick", "Lumen Essence", "Eternal Gloom Core"],
      jinglin: ["Faint Wick", "Lumen Essence", "Eternal Gloom Core"],
      kasimira: ["Backstage Ragged Hat", "Spotlight Bowler", "Exeunt Bowler"],
      laru: ["Backstage Ragged Hat", "Spotlight Bowler", "Exeunt Bowler"],
      minova: ["Faint Wick", "Lumen Essence", "Eternal Gloom Core"],
      mistique: ["Count's Rewards", "Count's Cellaring", "Count's Gift"],
      nanoha: ["Faint Wick", "Lumen Essence", "Eternal Gloom Core"],
      nazuna: ["Count's Rewards", "Count's Cellaring", "Count's Gift"],
      noya: ["Backstage Ragged Hat", "Spotlight Bowler", "Exeunt Bowler"],
      ridge: ["Faint Wick", "Lumen Essence", "Eternal Gloom Core"],
      shia: ["Count's Rewards", "Count's Cellaring", "Count's Gift"],
      shimiao: ["Backstage Ragged Hat", "Spotlight Bowler", "Exeunt Bowler"],
      teresa: ["Count's Rewards", "Count's Cellaring", "Count's Gift"],
      tilia: ["Count's Rewards", "Count's Cellaring", "Count's Gift"]
    };

    const characterDiscAscensionMaterials = {};

    const characterSkillCartridges = {
      amber: ["Shooter Game Cartridge", "Barrage Game Cartridge", "Demon Bee Game Cartridge"],
      ann: ["Shooter Game Cartridge", "Barrage Game Cartridge", "Demon Bee Game Cartridge"],
      canace: ["Kung Fu Game Cartridge", "Fighting Game Cartridge", "Phantom Game Cartridge"],
      caramel: ["Tapping Game Cartridge", "Rhythm Game Cartridge", "Magic Sound Game Cartridge"],
      chitose: ["Shooter Game Cartridge", "Barrage Game Cartridge", "Demon Bee Game Cartridge"],
      chixia: ["Kung Fu Game Cartridge", "Fighting Game Cartridge", "Phantom Game Cartridge"],
      coronis: ["Shooter Game Cartridge", "Barrage Game Cartridge", "Demon Bee Game Cartridge"],
      cosette: ["Kung Fu Game Cartridge", "Fighting Game Cartridge", "Phantom Game Cartridge"],
      flora: ["Tapping Game Cartridge", "Rhythm Game Cartridge", "Magic Sound Game Cartridge"],
      freesia: ["Kung Fu Game Cartridge", "Fighting Game Cartridge", "Phantom Game Cartridge"],
      gerie: ["Kung Fu Game Cartridge", "Fighting Game Cartridge", "Phantom Game Cartridge"],
      iris: ["Kung Fu Game Cartridge", "Fighting Game Cartridge", "Phantom Game Cartridge"],
      jinglin: ["Kung Fu Game Cartridge", "Fighting Game Cartridge", "Phantom Game Cartridge"],
      kasimira: ["Kung Fu Game Cartridge", "Fighting Game Cartridge", "Phantom Game Cartridge"],
      laru: ["Tapping Game Cartridge", "Rhythm Game Cartridge", "Magic Sound Game Cartridge"],
      minova: ["Kung Fu Game Cartridge", "Fighting Game Cartridge", "Phantom Game Cartridge"],
      mistique: ["Shooter Game Cartridge", "Barrage Game Cartridge", "Demon Bee Game Cartridge"],
      nanoha: ["Tapping Game Cartridge", "Rhythm Game Cartridge", "Magic Sound Game Cartridge"],
      nazuna: ["Shooter Game Cartridge", "Barrage Game Cartridge", "Demon Bee Game Cartridge"],
      noya: ["Tapping Game Cartridge", "Rhythm Game Cartridge", "Magic Sound Game Cartridge"],
      ridge: ["Tapping Game Cartridge", "Rhythm Game Cartridge", "Magic Sound Game Cartridge"],
      shia: ["Shooter Game Cartridge", "Barrage Game Cartridge", "Demon Bee Game Cartridge"],
      shimiao: ["Shooter Game Cartridge", "Barrage Game Cartridge", "Demon Bee Game Cartridge"],
      teresa: ["Tapping Game Cartridge", "Rhythm Game Cartridge", "Magic Sound Game Cartridge"],
      tilia: ["Tapping Game Cartridge", "Rhythm Game Cartridge", "Magic Sound Game Cartridge"]
    };

    const WEEKLY_BOSS_GROUPS = {
      "Garden of Parasite": ["Crimson Tempter", "Evil Bloom Essence"],
      "Spirit of Brutality": ["Forest Elf Fang", "Forest Elf Essence"],
      "Spellbound Golem": ["Colossus Core", "Colossus Essence"],
      "Lithe Beauty": ["Wrath Beauty", "Wind Essence"],
      "Jade Balde": ["Radiant Feather Crown", "Radiant Crown Essence"],
      "Gobble Hexhorn Whale": ["Nightlit Haven", "Tidal Essence"]
    };

    const characterBossMaterials = {
      amber: ["Wrath Beauty"],
      ann: ["Wrath Beauty", "Wind Essence"],
      canace: ["Wrath Beauty", "Wind Essence"],
      caramel: ["Crimson Tempter", "Evil Bloom Essence"],
      chitose: ["Tidal Essence"],
      chixia: ["Colossus Essence"],
      coronis: ["Crimson Tempter", "Evil Bloom Essence"],
      cosette: ["Crimson Tempter", "Evil Bloom Essence"],
      flora: ["Colossus Core", "Colossus Essence"],
      freesia: ["Nightlit Haven"],
      gerie: ["Forest Elf Essence"],
      iris: ["Nightlit Haven", "Tidal Essence"],
      jinglin: ["Radiant Feather Crown", "Radiant Crown Essence"],
      kasimira: ["Colossus Core", "Colossus Essence"],
      laru: ["Radiant Feather Crown", "Radiant Crown Essence"],
      minova: ["Radiant Feather Crown", "Radiant Crown Essence"],
      mistique: ["Crimson Tempter", "Evil Bloom Essence"],
      nanoha: ["Wrath Beauty", "Wind Essence"],
      nazuna: ["Forest Elf Fang"],
      noya: ["Wrath Beauty", "Wind Essence"],
      ridge: ["Forest Elf Fang", "Forest Elf Essence"],
      shia: ["Radiant Feather Crown"],
      shimiao: ["Nightlit Haven", "Tidal Essence"],
      teresa: ["Nightlit Haven"],
      tilia: ["Radiant Feather Crown", "Radiant Crown Essence"]
    };

    /* ---------------------------
       Ascension tiers + experience + skill tables
    ----------------------------*/
    const ascensionTiersTemplate = [
      { level: 20, basic: 5, inter: 0, adv: 0, dorra: 7900 },
      { level: 30, basic: 5, inter: 10, adv: 0, dorra: 19800 },
      { level: 40, basic: 10, inter: 15, adv: 0, dorra: 44400 },
      { level: 50, basic: 15, inter: 25, adv: 0, dorra: 88000 },
      { level: 60, basic: 20, inter: 40, adv: 0, dorra: 146100 },
      { level: 70, basic: 30, inter: 55, adv: 20, dorra: 200000 },
      { level: 80, basic: 0, inter: 75, adv: 30, dorra: 250000 },
      { level: 90, basic: 0, inter: 95, adv: 50, dorra: 300000 }
    ];

    const experienceTable = [
      { from: 1, to: 2, exp: 1310, dorra: 300 }, { from: 2, to: 3, exp: 2180, dorra: 300 }, { from: 3, to: 4, exp: 3700, dorra: 600 },
      { from: 4, to: 5, exp: 4000, dorra: 600 }, { from: 5, to: 6, exp: 4400, dorra: 600 }, { from: 6, to: 7, exp: 4800, dorra: 750 },
      { from: 7, to: 8, exp: 5200, dorra: 750 }, { from: 8, to: 9, exp: 5500, dorra: 1100 }, { from: 9, to: 10, exp: 5700, dorra: 719 },
      { from: 10, to: 11, exp: 6270, dorra: 1050 }, { from: 11, to: 12, exp: 6800, dorra: 1050 }, { from: 12, to: 13, exp: 7350, dorra: 1350 },
      { from: 13, to: 14, exp: 7900, dorra: 1500 }, { from: 14, to: 15, exp: 8550, dorra: 1650 }, { from: 15, to: 16, exp: 12140, dorra: 1800 },
      { from: 16, to: 17, exp: 13310, dorra: 1950 }, { from: 17, to: 18, exp: 14480, dorra: 2250 }, { from: 18, to: 19, exp: 15660, dorra: 2250 },
      { from: 19, to: 20, exp: 16830, dorra: 2475 }, { from: 20, to: 21, exp: 17000, dorra: 2550 }, { from: 21, to: 22, exp: 17150, dorra: 2700 },
      { from: 22, to: 23, exp: 17300, dorra: 3000 }, { from: 23, to: 24, exp: 17440, dorra: 3250 }, { from: 24, to: 25, exp: 17590, dorra: 3750 },
      { from: 25, to: 26, exp: 17740, dorra: 4000 }, { from: 26, to: 27, exp: 17890, dorra: 4250 }, { from: 27, to: 28, exp: 18040, dorra: 4750 },
      { from: 28, to: 29, exp: 18190, dorra: 5000 }, { from: 29, to: 30, exp: 18330, dorra: 5500 }, { from: 30, to: 31, exp: 18510, dorra: 2850 },
      { from: 31, to: 32, exp: 19970, dorra: 3000 }, { from: 32, to: 33, exp: 21430, dorra: 3150 }, { from: 33, to: 34, exp: 22890, dorra: 3450 },
      { from: 34, to: 35, exp: 24530, dorra: 3750 }, { from: 35, to: 36, exp: 25820, dorra: 3750 }, { from: 36, to: 37, exp: 27280, dorra: 4200 },
      { from: 37, to: 38, exp: 28740, dorra: 4200 }, { from: 38, to: 39, exp: 30200, dorra: 4650 }, { from: 39, to: 40, exp: 31660, dorra: 4628 },
      { from: 50, to: 51, exp: 32720, dorra: 4950 }, { from: 51, to: 52, exp: 37000, dorra: 5500 }, { from: 52, to: 53, exp: 40980, dorra: 6150 },
      { from: 53, to: 54, exp: 45110, dorra: 6750 }, { from: 54, to: 55, exp: 49240, dorra: 7500 }, { from: 55, to: 56, exp: 53360, dorra: 7950 },
      { from: 56, to: 57, exp: 57490, dorra: 8550 }, { from: 57, to: 58, exp: 61620, dorra: 9300 }, { from: 58, to: 59, exp: 65750, dorra: 9900 },
      { from: 59, to: 60, exp: 69880, dorra: 10373 }, { from: 70, to: 71, exp: 87230, dorra: 13200 }, { from: 71, to: 72, exp: 93850, dorra: 14100 },
      { from: 72, to: 73, exp: 100460, dorra: 15000 }, { from: 73, to: 74, exp: 107080, dorra: 16050 }, { from: 74, to: 75, exp: 113690, dorra: 17100 },
      { from: 75, to: 76, exp: 120310, dorra: 18000 }, { from: 76, to: 77, exp: 126920, dorra: 19050 }, { from: 77, to: 78, exp: 133540, dorra: 20100 },
      { from: 78, to: 79, exp: 140150, dorra: 21000 }, { from: 79, to: 80, exp: 146770, dorra: 21900 }
    ];

    const skillMaterialTable = [
      { from: 1, to: 2, basic: 6, inter: 0, adv: 0, boss: 0, chess: 2 },
      { from: 2, to: 3, basic: 12, inter: 0, adv: 0, boss: 0, chess: 6 },
      { from: 3, to: 4, basic: 24, inter: 3, adv: 0, boss: 0, chess: 10 },
      { from: 4, to: 5, basic: 38, inter: 8, adv: 0, boss: 0, chess: 24 },
      { from: 5, to: 6, basic: 70, inter: 14, adv: 6, boss: 0, chess: 55 },
      { from: 6, to: 7, basic: 0, inter: 50, adv: 18, boss: 1, chess: 232 },
      { from: 7, to: 8, basic: 0, inter: 90, adv: 34, boss: 2, chess: 323 }
    ];

    const EXP_MATERIALS = [
      { name: "Trekker's Handwritten Encyclopedia", value: 20000 },
      { name: "Senior's Travel Journal", value: 10000 },
      { name: "Novice's Internship Journal", value: 5000 },
      { name: "Trekker's Guide", value: 1000 }
    ];

    function expToMaterials(expAmount) {
      const result = {};
      let remaining = Number(expAmount) || 0;
      for (const mat of EXP_MATERIALS) {
        const count = Math.floor(remaining / mat.value);
        if (count > 0) {
          result[mat.name] = (result[mat.name] || 0) + count;
          remaining -= count * mat.value;
        }
      }
      return result;
    }

    /* ---------------------------
       Calculation helpers
    ----------------------------*/
    function calculateSkillMaterials(fromLvl, toLvl) {
      const r = { basic: 0, inter: 0, adv: 0, boss: 0, chess: 0 };
      for (const s of skillMaterialTable) {
        if (s.to > fromLvl && s.to <= toLvl) {
          r.basic += s.basic || 0;
          r.inter += s.inter || 0;
          r.adv += s.adv || 0;
          r.boss += s.boss || 0;
          r.chess += s.chess || 0;
        }
      }
      return r;
    }

    function calculateExperienceNeeded(current, desired) {
      let totalExp = 0, totalDorra = 0;
      if (Number(desired) <= Number(current)) return { totalExp: 0, totalDorra: 0 };
      for (const row of experienceTable) {
        if (row.from >= Number(current) && row.to <= Number(desired)) {
          totalExp += (row.exp || 0);
          totalDorra += (row.dorra || 0);
        }
      }
      return { totalExp, totalDorra };
    }

    function buildCharacterWithTiers(ch) {
      const asc = characterAscensionMaterials[ch.id] || ['AscA', 'AscB', 'AscC'];
      const skill = characterSkillCartridges[ch.id] || [];
      const tiers = ascensionTiersTemplate.map(t => {
        const mats = [];
        if (t.basic > 0) mats.push({ id: `${ch.id}_asc1_${t.level}`, name: asc[0], count: t.basic, type: 'Ascension', rarity: 'Basic', image: ensureImage(asc[0]) });
        if (t.inter > 0) mats.push({ id: `${ch.id}_asc2_${t.level}`, name: asc[1], count: t.inter, type: 'Ascension', rarity: 'Intermediate', image: ensureImage(asc[1]) });
        if (t.adv > 0) mats.push({ id: `${ch.id}_asc3_${t.level}`, name: asc[2], count: t.adv, type: 'Ascension', rarity: 'Advanced', image: ensureImage(asc[2]) });
        mats.push({ id: `${ch.id}_dorra_${t.level}`, name: 'Dorra', count: t.dorra, type: 'Currency', image: ensureImage('Dorra') });
        return { level: t.level, materials: mats };
      });
      return { ...ch, tiers, ascensionMaterials: asc, skillMaterials: skill };
    }

    const characters = manifestCharacters.map(buildCharacterWithTiers);

    /* ---------------------------
       Category detection & sorting
    ----------------------------*/
    function detectCategoryForName(name) {
      if (!name) return 'Misc';
      for (const cid in characterAscensionMaterials) {
        const arr = characterAscensionMaterials[cid] || [];
        if (arr.includes(name)) return 'Ascension';
      }
      for (const cid in characterDiscAscensionMaterials) {
        const arr = characterDiscAscensionMaterials[cid] || [];
        if (arr.includes(name)) return 'Ascension';
      }
      for (const group in WEEKLY_BOSS_GROUPS) {
        if (WEEKLY_BOSS_GROUPS[group].includes(name)) return 'Boss';
      }
      if (MATERIAL_CATEGORY_MAP[name]) {
        const map = MATERIAL_CATEGORY_MAP[name];
        if (map === 'Currency') return 'Dorra';
        if (map === 'Skill Materials') return 'Skill';
        if (map === 'Ascension Materials') return 'Ascension';
        if (map === 'Weekly Boss') return 'Boss';
        if (map === 'Emblems') return 'Emblems';
        if (map === 'Experience') return 'Experience';
        if (map === 'Gifts') return 'Gifts';
        if (map === 'Disc') return 'Disc';
        return map;
      }
      const n = (name || '').toLowerCase();
      if (n.includes('dorra')) return 'Dorra';
      if (/exp|experience|trekker/i.test(name)) return 'Experience';
      return 'Misc';
    }

    function rarityValue(r) {
      if (!r) return 2;
      const x = (r || '').toString().toLowerCase();
      if (x.includes('basic')) return 1;
      if (x.includes('intermediate')) return 2;
      if (x.includes('advanced')) return 3;
      return 2;
    }

    function ascensionGroupIndex(itemName) {
      for (const g in characterAscensionMaterials) {
        const arr = characterAscensionMaterials[g];
        const idx = arr.indexOf(itemName);
        if (idx >= 0) return { group: g, idx };
      }
      return { group: null, idx: 9999 };
    }

    function skillGroupIndex(itemName) {
      for (const g in characterSkillCartridges) {
        const arr = characterSkillCartridges[g];
        const idx = arr.indexOf(itemName);
        if (idx >= 0) return { group: g, idx };
      }
      return { group: null, idx: 9999 };
    }

    function bossGroupIndex(itemName) {
      for (const g in characterBossMaterials) {
        const arr = characterBossMaterials[g];
        const idx = arr.indexOf(itemName);
        if (idx >= 0) return { group: g, idx };
      }
      return { group: null, idx: 9999 };
    }

    const ORDER_MAP = { 'Dorra': 0, 'Experience': 1, 'Character': 2, 'Disc': 3, 'Skill': 4, 'Ascension': 5, 'Boss': 6, 'Emblems': 7, 'Gifts': 8, 'Misc': 9 };

    function materialSort(a, b) {
      const an = (a && a.name) ? a.name : (a || '');
      const bn = (b && b.name) ? b.name : (b || '');
      const ca = detectCategoryForName(an);
      const cb = detectCategoryForName(bn);

      if (ca !== cb) return (ORDER_MAP[ca] || 999) - (ORDER_MAP[cb] || 999);

      const ra = rarityValue(a.rarity || '');
      const rb = rarityValue(b.rarity || '');
      if (ra !== rb) return ra - rb;

      if (ca === 'Ascension') {
        const aa = ascensionGroupIndex(an), bb = ascensionGroupIndex(bn);
        if (aa.group !== bb.group) return (aa.group || '').localeCompare(bb.group || '');
        if (aa.idx !== bb.idx) return aa.idx - bb.idx;
      }
      else if (ca === 'Skill') {
        const sa = skillGroupIndex(an), sb = skillGroupIndex(bn);
        if (sa.group !== sb.group) return (sa.group || '').localeCompare(sb.group || '');
        if (sa.idx !== sb.idx) return sa.idx - sb.idx;
      }
      else if (ca === 'Boss') {
        const ba = bossGroupIndex(an), bb = bossGroupIndex(bn);
        if (ba.group !== bb.group) return (ba.group || '').localeCompare(bb.group || '');
        if (ba.idx !== bb.idx) return ba.idx - bb.idx;
      }

      return an.localeCompare(bn);
    }

    /* ---------------------------
       Material calculations
    ----------------------------*/
    function calcAscensionMaterialsForChar(charId, currentLevel, desiredLevel) {
      const ch = characters.find(c => c.id === charId);
      if (!ch) return {};
      const tiers = ch.tiers.filter(t => t.level > currentLevel && t.level <= desiredLevel);
      const out = {};
      tiers.forEach(t => t.materials.forEach(m => {
        if (!out[m.name]) out[m.name] = { ...m };
        else out[m.name].count += m.count;
      }));
      return out;
    }

    function calcSkillMaterialsForChar(charId, curSkill, desSkill) {
      const diff = Math.max(0, Number(desSkill) - Number(curSkill));
      if (diff <= 0) return {};

      const mats = calculateSkillMaterials(Number(curSkill), Number(desSkill));
      const skillList = characterSkillCartridges[charId] || [];
      const out = {};

      if (mats.basic > 0) {
        const nm = skillList[0] || 'Tapping Game Cartridge';
        out[nm] = { name: nm, image: ensureImage(nm), type: 'Skill', rarity: 'Basic', count: mats.basic };
      }
      if (mats.inter > 0) {
        const nm = skillList[1] || 'Rhythm Game Cartridge';
        out[nm] = { name: nm, image: ensureImage(nm), type: 'Skill', rarity: 'Intermediate', count: mats.inter };
      }
      if (mats.adv > 0) {
        const nm = skillList[2] || 'Magic Sound Game Cartridge';
        out[nm] = { name: nm, image: ensureImage(nm), type: 'Skill', rarity: 'Advanced', count: mats.adv };
      }
      if (mats.chess > 0) {
        const nm = 'Chess Piece of Skill';
        out[nm] = { name: nm, image: ensureImage(nm), type: 'Skill', rarity: 'Misc', count: mats.chess };
      }
      if (mats.boss > 0) {
        const bossList = characterBossMaterials[charId] || [];
        if (bossList.length > 0) {
          out[bossList[0]] = { name: bossList[0], image: ensureImage(bossList[0]), type: 'Boss', count: mats.boss };
        }
      }
      return out;
    }

    function aggregateMaps(listOfMaps) {
      const out = {};
      listOfMaps.forEach(m => {
        for (const k in m) {
          if (!out[k]) out[k] = { ...m[k] };
          else out[k].count += m[k].count;
        }
      });
      return out;
    }

    function computeMaterialsForConfig(cfg) {
      const asc = calcAscensionMaterialsForChar(cfg.charId, cfg.currentLevel, cfg.desiredLevel);
      const atk = calcSkillMaterialsForChar(cfg.charId, cfg.atkCur, cfg.atkDes);
      const main = calcSkillMaterialsForChar(cfg.charId, cfg.mainCur, cfg.mainDes);
      const sup = calcSkillMaterialsForChar(cfg.charId, cfg.supCur, cfg.supDes);
      const ult = calcSkillMaterialsForChar(cfg.charId, cfg.ultCur, cfg.ultDes);
      const expCalc = calculateExperienceNeeded(cfg.currentLevel, cfg.desiredLevel);

      const expEntries = {};
      if (expCalc.totalExp > 0) {
        const breakdown = expToMaterials(expCalc.totalExp);
        for (const matName in breakdown) {
          expEntries[matName] = { name: matName, image: ensureImage(matName), type: 'Experience', count: breakdown[matName] };
        }
      }

      const dorraMap = {};
      if (expCalc.totalDorra > 0) dorraMap['Dorra'] = { name: 'Dorra', image: ensureImage('Dorra'), type: 'Currency', count: expCalc.totalDorra };

      return Object.values(aggregateMaps([asc, atk, main, sup, ult, expEntries, dorraMap]));
    }

    function computeCombinedTotals() {
      const saved = loadSaved().filter(cfg => !cfg.ignored && !cfg.completed);
      const maps = saved.map(cfg => {
        const asc = calcAscensionMaterialsForChar(cfg.charId, cfg.currentLevel, cfg.desiredLevel);
        const atk = calcSkillMaterialsForChar(cfg.charId, cfg.atkCur, cfg.atkDes);
        const main = calcSkillMaterialsForChar(cfg.charId, cfg.mainCur, cfg.mainDes);
        const sup = calcSkillMaterialsForChar(cfg.charId, cfg.supCur, cfg.supDes);
        const ult = calcSkillMaterialsForChar(cfg.charId, cfg.ultCur, cfg.ultDes);
        const expCalc = calculateExperienceNeeded(cfg.currentLevel, cfg.desiredLevel);
        const expEntries = {};
        if (expCalc.totalExp > 0) {
          const breakdown = expToMaterials(expCalc.totalExp);
          for (const matName in breakdown) expEntries[matName] = { name: matName, image: ensureImage(matName), type: 'Experience', count: breakdown[matName] };
        }
        const dorraMap = {};
        if (expCalc.totalDorra > 0) dorraMap['Dorra'] = { name: 'Dorra', image: ensureImage('Dorra'), type: 'Currency', count: expCalc.totalDorra };
        return aggregateMaps([asc, atk, main, sup, ult, expEntries, dorraMap]);
      });
      const merged = {};
      maps.forEach(m => {
        for (const k in m) {
          if (!merged[k]) merged[k] = { ...m[k] };
          else merged[k].count += m[k].count;
        }
      });
      return Object.values(merged);
    }

    /* ---------------------------
       Storage helpers
    ----------------------------*/
    const STORAGE_KEY = 'stella_final_configs_v2';
    const INVENTORY_KEY = 'STELLA_INVENTORY_DATA';
    const THEME_KEY = 'STELLA_THEME_MODE';
    const VIEW_MODE_KEY = 'STELLA_MATERIALS_VIEW_MODE';

    const loadSaved = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const saveAll = arr => localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    const addOrUpdate = cfg => {
      const arr = loadSaved();
      const idx = arr.findIndex(x => x.id === cfg.id);
      if (idx >= 0) arr[idx] = cfg;
      else arr.push(cfg);
      saveAll(arr);
    }
    const removeConfig = id => saveAll(loadSaved().filter(x => x.id !== id));
    const loadInventory = () => {
      try {
        return JSON.parse(localStorage.getItem(INVENTORY_KEY) || '{}');
      } catch (e) {
        return {};
      }
    };
    const saveInventory = obj => localStorage.setItem(INVENTORY_KEY, JSON.stringify(obj || {}));

    /* ---------------------------
       Render materials summary
    ----------------------------*/
    const materialsGrid = $('#materialsGrid');
    const btnTotal = $('#btnTotalNeeded');
    const btnRemaining = $('#btnRemainingNeeded');

    function getMaterialsViewMode() {
      return localStorage.getItem(VIEW_MODE_KEY) || 'total';
    }

    function updateModeButtons(mode) {
      btnTotal.classList.toggle('active', mode === 'total');
      btnRemaining.classList.toggle('active', mode === 'remaining');
    }

    function setMaterialsViewMode(m) {
      localStorage.setItem(VIEW_MODE_KEY, m);
      updateModeButtons(m);
      renderMaterials(m);
    }

    function renderMaterials(mode = 'total') {
      const arr = computeCombinedTotals();
      arr.sort(materialSort);
      const inv = loadInventory();
      materialsGrid.innerHTML = '';

      if (!arr.length) {
        materialsGrid.innerHTML = '<div class="small muted">Add characters to see totals.</div>';
        return;
      }

      arr.forEach(it => {
        let count = it.count || 0;
        if (mode === 'remaining') {
          const invCount = (inv.counts && inv.counts[it.name]) ? Number(inv.counts[it.name]) : 0;
          count = Math.max(0, count - invCount);
          if (count <= 0) return;
        }
        const imgPath = ensureImage(it.image || it.name);
        const d = el('div', { class: 'material', 'data-tooltip': it.name || '' });
        d.innerHTML = `<img src="${imgPath}" alt="${it.name}"><div class="mat-count">${count}</div>`;
        materialsGrid.appendChild(d);
      });
    }

    /* ---------------------------
       Render saved characters
    ----------------------------*/
    const characterGrid = $('#characterGrid');

    function renderSavedCharacters() {
      characterGrid.innerHTML = '';
      const saved = loadSaved();
      const visible = saved.filter(cfg => !cfg.completed);

      if (!visible.length) {
        characterGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center" class="muted">No characters yet â€” click Add Character to begin.</div>';
        return;
      }

      visible.forEach(cfg => {
        const ch = characters.find(c => c.id === cfg.charId);
        if (!ch) return;

        const card = el('div', { class: 'character-card card' });
        if (cfg.ignored) card.classList.add('dimmed');

        // Top row
        const top = el('div', { class: 'char-top' });
        const leftA = el('div', { class: 'char-actions-left' });

        const editBtn = el('button', { class: 'icon-btn', title: 'Edit' });
        editBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12V21h8.97L21 12.03 14.98 6 3 12z" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        editBtn.addEventListener('click', () => openDetailsForEdit(cfg.id));

        const completeBtn = el('button', { class: 'icon-btn', title: 'Complete' });
        completeBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M10 15l-3.5-3.5L6 13l4 4 8-8-1.5-1.5L10 15z" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        completeBtn.addEventListener('click', () => {
          if (!confirm(`Mark ${ch.name} as completed (assume materials collected)?`)) return;
          cfg.completed = true;
          addOrUpdate(cfg);
          renderSavedCharacters();
          renderMaterials(getMaterialsViewMode());
          populateModalCharacters();
        });

        leftA.appendChild(editBtn);
        leftA.appendChild(completeBtn);

        const rightA = el('div', { class: 'char-actions-right' });

        const deleteBtn = el('button', { class: 'icon-btn', title: 'Delete' });
        deleteBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 7h12v12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V7z M9 3h6l1 2H8l1-2z" stroke-width="1.2"/></svg>';
        deleteBtn.addEventListener('click', () => {
          if (!confirm(`Delete ${ch.name}?`)) return;
          removeConfig(cfg.id);
          renderSavedCharacters();
          renderMaterials(getMaterialsViewMode());
          populateModalCharacters();
        });

        const hideBtn = el('button', { class: 'icon-btn', title: cfg.ignored ? 'Show' : 'Hide' });
        hideBtn.innerHTML = cfg.ignored ?
          '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5z" stroke-width="1.2"/></svg>' :
          '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7z" stroke-width="1.2"/></svg>';
        hideBtn.addEventListener('click', () => {
          cfg.ignored = !cfg.ignored;
          addOrUpdate(cfg);
          if (cfg.ignored) card.classList.add('dimmed');
          else card.classList.remove('dimmed');
          hideBtn.title = cfg.ignored ? 'Show' : 'Hide';
          hideBtn.innerHTML = cfg.ignored ?
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5z" stroke-width="1.2"/></svg>' :
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7z" stroke-width="1.2"/></svg>';
          renderSavedCharacters();
          renderMaterials(getMaterialsViewMode());
          populateModalCharacters();
        });

        rightA.appendChild(deleteBtn);
        rightA.appendChild(hideBtn);

        const nameDiv = el('div', { class: 'char-name' }, ch.name);
        top.appendChild(leftA);
        top.appendChild(nameDiv);
        top.appendChild(rightA);
        card.appendChild(top);

        // Body
        const body = el('div', { class: 'char-body' });
        const portrait = el('div', { class: 'char-portrait' });
        portrait.style.backgroundImage = `url(${ch.image})`;

        const info = el('div', { class: 'char-info' });
        const lv = el('div', { class: 'char-levels' });
        lv.innerHTML = `<div style="font-weight:700">Levels</div><div class="small">${cfg.currentLevel} â†’ ${cfg.desiredLevel}</div>`;

        const skillsWrap = el('div', { class: 'char-skills' });
        skillsWrap.innerHTML = `<div style="font-weight:700">Skills</div>`;

        const addSkillRow = (label, curv, desv) => {
          const row = el('div', { class: 'skill-row' });
          row.innerHTML = `<div class="skill-label">${label}</div><div class="skill-values small">${curv} â†’ ${desv}</div>`;
          skillsWrap.appendChild(row);
        };

        addSkillRow('Attack', cfg.atkCur, cfg.atkDes);
        addSkillRow('Main', cfg.mainCur, cfg.mainDes);
        addSkillRow('Support', cfg.supCur, cfg.supDes);
        addSkillRow('Ultimate', cfg.ultCur, cfg.ultDes);

        info.appendChild(lv);
        info.appendChild(skillsWrap);
        body.appendChild(portrait);
        body.appendChild(info);
        card.appendChild(body);

        // Materials preview
        const mats = computeMaterialsForConfig(cfg);
        const matWrap = el('div', { class: 'char-materials' });
        mats.sort(materialSort).slice(0, 8).forEach(m => {
          const mm = el('div', { class: 'char-material', 'data-tooltip': m.name || '' });
          mm.innerHTML = `<img src="${ensureImage(m.image || m.name)}" alt="${m.name}"><div style="font-weight:700">${m.count}</div>`;
          matWrap.appendChild(mm);
        });

        card.appendChild(matWrap);
        characterGrid.appendChild(card);
      });
    }

    /* ---------------------------
       List modal filters & population
    ----------------------------*/
    const listModal = $('#listModal');
    const modalTiles = $('#modalTiles');
    const listSearch = $('#listSearch');
    const listFilters = $('#listFilters');
    const closeListModal = $('#closeListModal');

    const FILTERS_FOR_LIST = [
      { label: 'Element', id: 'filterElement', options: ['', 'Aqua', 'Ignis', 'Terra', 'Ventus', 'Lux', 'Umbra'] },
      { label: 'Quality', id: 'filterQuality', options: ['', '4', '5'] },
      { label: 'Position', id: 'filterPosition', options: ['', 'Versatile', 'Vanguard', 'Support'] },
      { label: 'Faction', id: 'filterFaction', options: ['', 'Yunji Studio', 'Neo Grace Organization', 'Scarlet Sights Media', 'Grace Imperium', 'New Star Guild', 'Petal Bloom Guild', 'Imperial Guard', 'Ashwind Clan', 'Post Haste', 'Baize Bureau', 'United Harvest', 'Freelance Trekker', 'Trekker Association', 'Goodwind Homecare', 'Fenhuang Diner', 'White Cat Troupe'] },
      { label: 'Style', id: 'filterStyle', options: ['', 'Adventurous', 'Creative', 'Steady', 'Collector', 'Inquisitive'] }
    ];

    function createListFilters() {
      listFilters.innerHTML = '';
      FILTERS_FOR_LIST.forEach(f => {
        const lbl = el('label', { style: 'margin:0;font-size:13px;color:var(--muted-dark)' }, `${f.label}: `);
        const s = el('select', { id: f.id });
        f.options.forEach(opt => s.appendChild(el('option', {}, opt)));
        s.style.padding = '8px';
        s.style.borderRadius = '8px';
        s.style.border = '1px solid rgba(255,255,255,0.04)';
        s.style.background = 'rgba(0,0,0,0.06)';
        s.style.color = 'inherit';
        lbl.appendChild(s);
        listFilters.appendChild(lbl);
      });
    }

    function populateModalCharacters() {
      const saved = loadSaved();
      const q = (listSearch.value || '').toLowerCase();
      const fe = $('#filterElement')?.value || '';
      const fq = $('#filterQuality')?.value || '';
      const fp = $('#filterPosition')?.value || '';
      const ff = $('#filterFaction')?.value || '';
      const fs = $('#filterStyle')?.value || '';

      const sortBy = $('#sortCharactersSelect')?.value || 'default';

      modalTiles.innerHTML = '';
      let list = characters.map(c => ({ ...c, savedCfg: saved.find(s => s.charId === c.id) }));

      list = list.filter(c => {
        if (q && !(c.name.toLowerCase().includes(q) || (c.element || '').toLowerCase().includes(q) || (c.id || '').toLowerCase().includes(q))) return false;
        if (fe && c.element !== fe) return false;
        if (fq && c.quality !== fq) return false;
        if (fp && c.position !== fp) return false;
        if (ff && c.faction !== ff) return false;
        if (fs && c.style !== fs) return false;
        return true;
      });

      list.sort((a, b) => {
        switch (sortBy) {
          case 'name': return a.name.localeCompare(b.name);
          case 'element': return (a.element || '').localeCompare(b.element || '');
          case 'quality': return (b.quality || '').localeCompare(a.quality || '');
          case 'position': return (a.position || '').localeCompare(b.position || '');
          case 'faction': return (a.faction || '').localeCompare(b.faction || '');
          default: return 0;
        }
      });

      list.forEach(c => {
        const tile = el('div', { class: 'tile' });
        const already = saved.find(s => s.charId === c.id && !s.completed);
        if (already) tile.classList.add('disabled');
        tile.innerHTML = `<img src="${c.image}" alt="${c.name}"><div style="font-weight:800">${c.name}</div><div class="small muted">${c.element} â€¢ ${c.quality}â˜…</div>`;
        tile.addEventListener('click', () => {
          if (tile.classList.contains('disabled')) return;
          listModal.classList.remove('open');
          listModal.setAttribute('aria-hidden', 'true');
          openDetailsForNew(c.id);
        });
        modalTiles.appendChild(tile);
      });
    }

    $('#addCharacterBtn').addEventListener('click', () => {
      createListFilters();
      populateModalCharacters();
      listModal.classList.add('open');
      listModal.setAttribute('aria-hidden', 'false');

      FILTERS_FOR_LIST.forEach(f => {
        const filterEl = $(`#${f.id}`);
        if (filterEl) {
          filterEl.addEventListener('change', populateModalCharacters);
        }
      });
    });

    closeListModal.addEventListener('click', () => listModal.classList.remove('open'));

    /* ---------------------------
       Details modal behavior
    ----------------------------*/
    const detailsModalEl = $('#detailsModal');
    const detailsPortrait = $('#detailsPortrait');
    const detailsName = $('#detailsName');
    const detailsSub = $('#detailsSub');
    const curLevel = $('#curLevel');
    const desLevel = $('#desLevel');
    const talentsInput = $('#talentsInput');
    const saveDetailsBtn = $('#saveDetails');
    const detailsCloseBtn = $('#detailsClose');
    let editingConfigId = null;

    function fillSkillSelects() {
      const curSelects = $$('.skill-cur', detailsModalEl);
      const desSelects = $$('.skill-des', detailsModalEl);
      [curSelects, desSelects].forEach(group => group.forEach(s => {
        s.innerHTML = '';
        for (let i = 1; i <= 10; i++) s.appendChild(el('option', { value: i }, i));
      }));
    }

    const LEVEL_OPTIONS = [1, 10, 20, 30, 40, 50, 60, 70, 80, 90];

    function buildLevelSelects() {
      curLevel.innerHTML = '';
      desLevel.innerHTML = '';
      LEVEL_OPTIONS.forEach(l => {
        curLevel.appendChild(el('option', { value: l }, l));
        desLevel.appendChild(el('option', { value: l }, l));
      });
      curLevel.classList.add('level-select');
      desLevel.classList.add('level-select');
    }

    function maxSkillForLevel(level) {
      const lv = Number(level);
      if (lv < 20) return 1;
      if (lv < 30) return 2;
      if (lv < 40) return 3;
      if (lv < 50) return 4;
      if (lv < 60) return 5;
      if (lv < 70) return 6;
      if (lv < 80) return 7;
      if (lv < 90) return 8;
      return 10;
    }

    function enforceSkillCapsForCurrentLevel() {
      const curLv = Number(curLevel.value);
      const desLv = Number(desLevel.value);
      const curMax = maxSkillForLevel(curLv);
      const desMax = maxSkillForLevel(desLv);

      const curSel = $$('.skill-cur', detailsModalEl);
      const desSel = $$('.skill-des', detailsModalEl);

      curSel.forEach(s => {
        const val = Number(s.value);
        Array.from(s.options).forEach(opt => opt.disabled = Number(opt.value) > curMax);
        if (val > curMax) s.value = curMax;
      });

      desSel.forEach(s => {
        const val = Number(s.value);
        Array.from(s.options).forEach(opt => opt.disabled = Number(opt.value) > desMax);
        if (val > desMax) s.value = desMax;
      });

      for (let i = 0; i < curSel.length; i++) {
        const c = Number(curSel[i].value) || 1;
        const d = Number(desSel[i].value) || 1;
        if (d < c) desSel[i].value = c;
      }
    }

    function enforceLevelMonotonicity() {
      const cur = Number(curLevel.value);
      const des = Number(desLevel.value);
      if (des < cur) desLevel.value = cur;
    }

    function openDetailsForNew(charId) {
      editingConfigId = null;
      const ch = characters.find(c => c.id === charId);
      if (!ch) return;

      detailsPortrait.style.backgroundImage = `url(${ch.image})`;
      detailsName.textContent = ch.name;
      detailsSub.textContent = `${ch.element} â€¢ ${ch.quality}â˜… â€¢ ${ch.position}`;
      buildLevelSelects();
      fillSkillSelects();
      curLevel.value = '1';
      desLevel.value = '1';
      const curSel = $$('.skill-cur')[0];
      if (curSel) curSel.value = '1';
      $$('.skill-des').forEach(s => s.value = '1');
      talentsInput.value = '0';
      $('#obtainedFlag').checked = false;
      enforceSkillCapsForCurrentLevel();
      detailsModalEl.classList.add('open');
      detailsModalEl.setAttribute('aria-hidden', 'false');
    }

    function openDetailsForEdit(cfgId) {
      const saved = loadSaved();
      const cfg = saved.find(x => x.id === cfgId);
      if (!cfg) return;

      editingConfigId = cfgId;
      const ch = characters.find(c => c.id === cfg.charId);
      if (!ch) return;

      detailsPortrait.style.backgroundImage = `url(${ch.image})`;
      detailsName.textContent = ch.name;
      detailsSub.textContent = `${ch.element} â€¢ ${ch.quality}â˜… â€¢ ${ch.position}`;
      buildLevelSelects();
      fillSkillSelects();
      curLevel.value = cfg.currentLevel;
      desLevel.value = cfg.desiredLevel;
      const curSelArr = $$('.skill-cur');
      const desSelArr = $$('.skill-des');
      if (curSelArr[0]) curSelArr[0].value = cfg.atkCur;
      if (desSelArr[0]) desSelArr[0].value = cfg.atkDes;
      if (curSelArr[1]) curSelArr[1].value = cfg.mainCur;
      if (desSelArr[1]) desSelArr[1].value = cfg.mainDes;
      if (curSelArr[2]) curSelArr[2].value = cfg.supCur;
      if (desSelArr[2]) desSelArr[2].value = cfg.supDes;
      if (curSelArr[3]) curSelArr[3].value = cfg.ultCur;
      if (desSelArr[3]) desSelArr[3].value = cfg.ultDes;
      talentsInput.value = cfg.talents || 0;
      $('#obtainedFlag').checked = !!cfg.obtained;
      enforceSkillCapsForCurrentLevel();
      detailsModalEl.classList.add('open');
      detailsModalEl.setAttribute('aria-hidden', 'false');
    }

    curLevel.addEventListener('change', () => {
      enforceLevelMonotonicity();
      enforceSkillCapsForCurrentLevel();
    });

    desLevel.addEventListener('change', () => {
      enforceLevelMonotonicity();
      enforceSkillCapsForCurrentLevel();
    });

    detailsModalEl.addEventListener('change', (e) => {
      if (e.target && (e.target.classList && (e.target.classList.contains('skill-cur') || e.target.classList.contains('skill-des')))) {
        enforceSkillCapsForCurrentLevel();
      }
    });

    saveDetailsBtn.addEventListener('click', () => {
      const curSelArr = $$('.skill-cur');
      const desSelArr = $$('.skill-des');
      const cfg = {
        id: editingConfigId || `cfg_${Date.now()}`,
        charId: characters.find(c => c.name === detailsName.textContent)?.id || characters[0].id,
        currentLevel: Number(curLevel.value),
        desiredLevel: Number(desLevel.value),
        atkCur: Number(curSelArr[0]?.value || 1),
        atkDes: Number(desSelArr[0]?.value || 1),
        mainCur: Number(curSelArr[1]?.value || 1),
        mainDes: Number(desSelArr[1]?.value || 1),
        supCur: Number(curSelArr[2]?.value || 1),
        supDes: Number(desSelArr[2]?.value || 1),
        ultCur: Number(curSelArr[3]?.value || 1),
        ultDes: Number(desSelArr[3]?.value || 1),
        talents: Number(talentsInput.value || 0),
        obtained: $('#obtainedFlag').checked,
        ignored: false,
        completed: false
      };

      if (cfg.desiredLevel < cfg.currentLevel) cfg.desiredLevel = cfg.currentLevel;
      if (cfg.atkDes < cfg.atkCur) cfg.atkDes = cfg.atkCur;
      if (cfg.mainDes < cfg.mainCur) cfg.mainDes = cfg.mainCur;
      if (cfg.supDes < cfg.supCur) cfg.supDes = cfg.supCur;
      if (cfg.ultDes < cfg.ultCur) cfg.ultDes = cfg.ultCur;

      addOrUpdate(cfg);
      detailsModalEl.classList.remove('open');
      detailsModalEl.setAttribute('aria-hidden', 'true');
      renderSavedCharacters();
      renderMaterials(getMaterialsViewMode());
      populateModalCharacters();
    });

    detailsCloseBtn.addEventListener('click', () => {
      detailsModalEl.classList.remove('open');
      detailsModalEl.setAttribute('aria-hidden', 'true');
    });

    /* ---------------------------
       Inventory modal logic
    ----------------------------*/
    const manageInventoryBtn = $('#manageInventoryBtn');
    const inventoryModal = $('#inventoryModal');
    const inventoryGrid = $('#inventoryGrid');
    const inventoryFilter = $('#inventoryFilter');
    const inventoryDorra = $('#inventoryDorra');
    const inventorySaveClose = $('#inventorySaveClose');
    const inventoryDeleteAll = $('#inventoryDeleteAll');
    const inventoryImportBtn = $('#inventoryImport');
    const inventoryExportBtn = $('#inventoryExport');
    const invImportFile = $('#invImportFile');

    function buildMasterMaterialsList() {
      const set = {};

      for (const k in characterAscensionMaterials) {
        (characterAscensionMaterials[k] || []).forEach(n => {
          if (!n) return;
          set[n] = { name: n, image: getMaterialImagePath(n), category: detectCategoryForName(n) };
        });
      }

      for (const k in characterSkillCartridges) {
        (characterSkillCartridges[k] || []).forEach(n => {
          if (!n) return;
          set[n] = { name: n, image: getMaterialImagePath(n), category: detectCategoryForName(n) };
        });
      }

      for (const k in characterBossMaterials) {
        (characterBossMaterials[k] || []).forEach(n => {
          if (!n) return;
          set[n] = { name: n, image: getMaterialImagePath(n), category: detectCategoryForName(n) };
        });
      }

      for (const group in WEEKLY_BOSS_GROUPS) {
        (WEEKLY_BOSS_GROUPS[group] || []).forEach(n => {
          if (!n) return;
          set[n] = { name: n, image: getMaterialImagePath(n), category: detectCategoryForName(n) };
        });
      }

      EXP_MATERIALS.forEach(m => {
        set[m.name] = { name: m.name, image: getMaterialImagePath(m.name), category: 'Experience' };
      });

      ['Cracked Disc', 'Pure Quality Treasure', 'Elegant Rim', 'Starlit Colored Glass'].forEach(n => {
        set[n] = { name: n, image: getMaterialImagePath(n), category: 'Disc' };
      });

      ['Good Citizen Point', 'Association Contribution Certificate', 'Grace Voucher'].forEach(n => {
        set[n] = { name: n, image: getMaterialImagePath(n), category: 'Emblems' };
      });

      ['Love Candle', 'Blazing Wings', 'Card Photo Capturer', 'Reflective Photo Capturer',
        'Portable Blower', 'Exquisite Blower', 'Whisper Wind Spinner', 'Chilling Wind Spinner',
        'Rising Star', 'Emerging Talent', 'Stellanite Enchantment', 'Moonlit Companion',
        'Summer Chill Crushed Ice', 'Fragrant Ice Delight', 'Gilded Ceramic Bowl', 'Blossom Porcelain Cup'].forEach(n => {
          set[n] = { name: n, image: getMaterialImagePath(n), category: 'Gifts' };
        });

      for (const k in characterDiscAscensionMaterials) {
        (characterDiscAscensionMaterials[k] || []).forEach(n => {
          if (!n) return;
          set[n] = { name: n, image: getMaterialImagePath(n), category: detectCategoryForName(n) };
        });
      }

      delete set['Dorra'];
      return Object.values(set);
    }

    let masterMaterials = buildMasterMaterialsList();

    function matchesFilterCategory(item, filterLabel) {
      if (!filterLabel || filterLabel === 'All') return true;
      const category = item.category || detectCategoryForName(item.name);

      switch (filterLabel) {
        case 'Experience': return category === 'Experience';
        case 'Character': return category === 'Ascension';
        case 'Disc': return category === 'Disc';
        case 'Skill Materials': return category === 'Skill';
        case 'Disc Materials': return category === 'Disc';
        case 'Ascension Materials': return category === 'Ascension';
        case 'Weekly Boss': return category === 'Boss';
        case 'Emblems': return category === 'Emblems';
        case 'Gifts': return category === 'Gifts';
        case 'Miscellaneous': return !category || category === 'Misc';
        default: return true;
      }
    }

    function renderInventoryGrid() {
      const inv = loadInventory();
      const counts = inv.counts || {};
      const filterVal = inventoryFilter.value;
      masterMaterials = buildMasterMaterialsList();
      const items = masterMaterials.slice().sort(materialSort);
      inventoryGrid.innerHTML = '';

      items.forEach(item => {
        if (!matchesFilterCategory(item, filterVal)) return;
        const div = el('div', { class: 'inv-item', 'data-tooltip': item.name || '' });
        const val = counts[item.name] || 0;
        div.innerHTML = `<img src="${ensureImage(item.image || item.name)}" alt="${item.name}"><input class="inv-input" type="number" min="0" value="${val}" data-name="${item.name}">`;
        inventoryGrid.appendChild(div);
      });

      inventoryDorra.value = inv.dorra || '';
    }

    manageInventoryBtn.addEventListener('click', () => {
      masterMaterials = buildMasterMaterialsList();
      inventoryModal.classList.add('open');
      inventoryModal.setAttribute('aria-hidden', 'false');
      renderInventoryGrid();
    });

    inventoryFilter.addEventListener('change', renderInventoryGrid);

    inventorySaveClose.addEventListener('click', () => {
      const inputs = $$('.inv-input', inventoryGrid);
      const counts = {};
      inputs.forEach(inp => {
        const n = inp.dataset.name;
        const v = Number(inp.value) || 0;
        counts[n] = v;
      });
      const dorraVal = Number(inventoryDorra.value) || 0;
      saveInventory({ counts, dorra: dorraVal });
      inventoryModal.classList.remove('open');
      inventoryModal.setAttribute('aria-hidden', 'true');
      renderMaterials(getMaterialsViewMode());
    });

    inventoryDeleteAll.addEventListener('click', () => {
      if (!confirm('Delete all inventory data? This cannot be undone.')) return;
      localStorage.removeItem(INVENTORY_KEY);
      renderInventoryGrid();
      inventoryDorra.value = '';
      inventoryModal.classList.remove('open');
      inventoryModal.setAttribute('aria-hidden', 'true');
      renderMaterials(getMaterialsViewMode());
    });

    inventoryExportBtn.addEventListener('click', () => {
      const inv = loadInventory() || { counts: {}, dorra: 0 };
      const blob = new Blob([JSON.stringify(inv, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'inventory_backup.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    inventoryImportBtn.addEventListener('click', () => {
      invImportFile.value = '';
      invImportFile.click();
    });

    invImportFile.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const parsed = JSON.parse(ev.target.result);
          const hasCounts = parsed && typeof parsed.counts === 'object' && parsed.counts !== null && !Array.isArray(parsed.counts);
          if (typeof parsed !== 'object' || parsed === null || !hasCounts) {
            if (!confirm('Imported file does not look like an inventory file. Continue and save anyway?')) return;
          }
          saveInventory(parsed);
          alert('Inventory imported successfully.');
          renderInventoryGrid();
          renderMaterials(getMaterialsViewMode());
        } catch (err) {
          alert('Failed to parse JSON: ' + err.message);
        }
      };
      reader.readAsText(f);
    });

    inventoryModal.addEventListener('click', e => {
      if (e.target === inventoryModal) {
        inventoryModal.classList.remove('open');
        inventoryModal.setAttribute('aria-hidden', 'true');
      }
    });

    /* ---------------------------
       Theme handling
    ----------------------------*/
    const themeToggle = $('#themeToggle');

    function applySavedTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === 'light') {
        document.body.classList.add('light');
        themeToggle.textContent = 'â˜€ï¸';
      } else {
        document.body.classList.remove('light');
        themeToggle.textContent = 'ðŸŒ™';
      }
    }

    themeToggle.addEventListener('click', () => {
      if (document.body.classList.contains('light')) {
        document.body.classList.remove('light');
        localStorage.setItem(THEME_KEY, 'dark');
        themeToggle.textContent = 'ðŸŒ™';
      } else {
        document.body.classList.add('light');
        localStorage.setItem(THEME_KEY, 'light');
        themeToggle.textContent = 'â˜€ï¸';
      }
    });

    applySavedTheme();

    /* ---------------------------
       Import JSON for characters
    ----------------------------*/
    const importBtn = $('#importBtn');
    const importFile = document.createElement('input');
    importFile.type = 'file';
    importFile.accept = 'application/json';
    importFile.style.display = 'none';
    document.body.appendChild(importFile);

    importBtn.addEventListener('click', () => {
      importFile.click();
    });

    importFile.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const bundle = JSON.parse(ev.target.result);
          if (bundle.configs) {
            saveAll(bundle.configs);
            alert('Character data imported successfully!');
            renderSavedCharacters();
            renderMaterials(getMaterialsViewMode());
            populateModalCharacters();
          } else {
            alert('No character data found in the imported file.');
          }
        } catch (err) {
          alert('Failed to parse JSON: ' + err.message);
        }
      };
      reader.readAsText(file);
    });

    /* ---------------------------
       Export bundle
    ----------------------------*/
    const exportBtn = $('#exportBtn');
    exportBtn.addEventListener('click', () => {
      const bundle = { configs: loadSaved(), inventory: loadInventory() };
      const blob = new Blob([JSON.stringify(bundle, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'stella_export.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    /* ---------------------------
       Initialization & wiring
    ----------------------------*/
    btnTotal.addEventListener('click', () => setMaterialsViewMode('total'));
    btnRemaining.addEventListener('click', () => setMaterialsViewMode('remaining'));

    (function init() {
      masterMaterials = buildMasterMaterialsList();
      createListFilters();
      populateModalCharacters();
      const mode = localStorage.getItem(VIEW_MODE_KEY) || 'total';
      updateModeButtons(mode);
      renderMaterials(mode);
      renderSavedCharacters();

      const sortSelect = $('#sortCharactersSelect');
      if (sortSelect) {
        sortSelect.addEventListener('change', populateModalCharacters);
      }

      listSearch.addEventListener('input', populateModalCharacters);

      FILTERS_FOR_LIST.forEach(f => {
        const filterEl = $(`#${f.id}`);
        if (filterEl) {
          filterEl.addEventListener('change', populateModalCharacters);
        }
      });
    })();
  </script>
</body>

</html>
